# Техническое Задание: AI Trading Terminal (Hyperliquid + Gemini)

## 1. Общее описание
Создание Telegram-бота для полуавтоматической торговли на деривативной платформе Hyperliquid. Бот предназначен для **персонального использования**.
Использует **Google Gemini 1.5 Pro (Free Tier)** для анализа структуры рынка (Волны Эллиотта, Вайкофф) на таймфреймах **15m - 1H**.
Бот предоставляет визуальный прогноз и исполняет торговые ордера через **Agent Wallet API** с автоматическим риск-менеджментом.

---

## 2. Функциональные модули

### 2.1. Модуль настройки и безопасности (Core & Auth)
*   **Agent Wallet (Приоритет безопасности):** Бот не использует основной приватный ключ. Вместо этого генерируется локальный "Agent Wallet", который авторизуется пользователем через веб-интерфейс Hyperliquid только для торговли.
*   **База данных:** SQLite для хранения истории сделок, метрики PnL и состояния "Agent Wallet" (адрес, зашифрованный приватный ключ агента).
*   **Config:** `.env` файл для токена Telegram, ключа Gemini API и адреса основного кошелька.

### 2.2. Модуль данных и пре-процессинга (Data Layer)
*   **Сбор данных:** Выгрузка свечей (OHLCV) с Hyperliquid. Таймфреймы: 15m, 1H, 4H (для контекста).
*   **Расчет индикаторов (Hard Logic):** Перед отправкой в ИИ скрипт вычисляет:
    *   **RSI (14):** Для определения перекупленности/перепроданности.
    *   **ZigZag:** Математический расчет экстремумов (High/Low) для помощи ИИ в разметке волн.
    *   **Volume/CVD:** Анализ объемов для подтверждения пробоев.
*   **Формирование контекста:** Данные упаковываются в текстовый формат + CSV-строку для промпта.

### 2.3. Аналитический модуль (AI Analysis)
*   **Модель:** Google Gemini 1.5 Pro.
*   **Prompt Engineering:** Строгое требование анализа структуры рынка по методологиям Эллиотта и Вайкоффа.
*   **Output Format:** **Строгий JSON**. Никакого свободного текста в логическом блоке.
    ```json
    {
        "signal": "LONG", // or SHORT, NEUTRAL
        "confidence": 8, // 1-10
        "setup_name": "Wave 3 impulse + Wyckoff SOS",
        "entry_range": [10.5, 10.6],
        "stop_loss": 10.2,
        "take_profit_1": 11.0,
        "take_profit_2": 11.5,
        "chart_comment": "Correction seems over..."
    }
    ```
*   **Визуализация:** Генерация графика (mplfinance) с нанесенными зонами TP/SL и комментарием ИИ.

### 2.4. Торговый модуль (Execution Engine)
*   **Интерфейс сигнала:** Сообщение в боте с графиком, JSON-данными и кнопками действия.
*   **Кнопки:** `[LONG MARKET]` `[SHORT MARKET]` `[CANCEL]`.
*   **Логика ордера:**
    1.  Открытие позиции по рынку.
    2.  Немедленная отправка OCO-связки (или отдельных ордеров) для TP и SL.
    3.  TP1 закрывает 50% позиции. TP2 закрывает остаток.
*   **Failsafe:** Если API возвращает ошибку или пинг слишком высокий, бот запрещает открытие новых позиций.

### 2.5. Модуль мониторинга (Positions)
*   **Monitor Loop:** Фоновый процесс (asyncio), обновляющий PnL открытых позиций раз в 30-60 секунд.
*   **Уведомления:** Алерт в Telegram при исполнении TP/SL.
*   **Panic Button:** Кнопка "Закрыть всё" в главном меню — немедленное закрытие всех позиций по рынку и отмена ордеров.

---

## 3. Сценарий использования (User Flow)
1.  **Старт:** Пользователь вводит тикер (например, `ETH`).
2.  **Анализ:**
    *   Бот качает данные, считает индикаторы.
    *   Gemini анализирует, возвращает JSON.
    *   Бот рисует график и присылает карточку сигнала.
3.  **Принятие решения:** Пользователь видит "Confidence: 8/10" и нажимает `[LONG MARKET]`.
4.  **Исполнение:** Бот создает ордер через Agent Wallet.
5.  **Инфо:** "Позиция открыта по $2500. SL: $2450, TP1: $2600".
6.  **Выход:** Срабатывает TP1 -> Бот присылает уведомление "TP1 hit! PnL: +$50. Остаток в безубытке".

---

## 4. Контроль рисков (Risk Management)
*   **Max Daily Loss:** (Опционально) Уведомление, если дневной убыток превысил N%.
*   **API Limits:** Обработка Rate Limit'ов Gemini (задержка между запросами, если лимит исчерпан).
*   **Sanity Check:** Скрипт проверяет, что `Stop Loss` < `Entry` для Лонга (и наоборот). Если ИИ ошибся в цифрах — ордер не выставляется, пользователю идет ошибка.

---

## 5. Технический стек
*   **Language:** Python 3.10+
*   **Trading SDK:** `hyperliquid-python-sdk` (Official/Community)
*   **AI:** `google-generativeai`
*   **DB:** `sqlite3` (через `aiosqlite`)
*   **Telegram:** `aiogram` 3.x
*   **Charting:** `mplfinance`

---

## 6. Стратегия разработки (Phases)
1.  **Setup:** Подключение Agent Wallet и проверка баланса.
2.  **Market Data:** Получение OHLCV и расчет индикаторов.
3.  **AI Integration:** Промптинг, JSON-валидация.
4.  **Trading Logic:** Выставление ордеров (Entry + TP/SL).
5.  **UI & Tests:** Сборка в Telegram-бота.
